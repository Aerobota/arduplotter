<%
  active = 'view'
  title = 'View Log'
%>
<div class="container">
	<div class="row">
		<div class="col-md-12">
			<p></p>
		</div>
	</div>
      
	<div class="row">
		<div class="col-md-12">
			<div class="btn-group" style="margin-bottom: 5px;">
				<div class="btn-group">
    			<button type="button" class="btn btn-default" disabled>Map Options:</button>
  			</div>
  			<div class="btn-group">
    			<button type="button" class="btn btn-default" onclick="app.play(0)" disabled><span class="glyphicon glyphicon-play"></span> Play Track</button>
  			</div>
				<div class="btn-group">
				  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" disabled>
				    Layers <span class="caret"></span>
				  </button>
				  <ul class="dropdown-menu" role="menu">
				    <li><a href="#">GPS Track</a></li>
				    <li><a href="#">Waypoints</a></li>
				  </ul>
				</div>
			</div>


			<div id="map-canvas"></div>
		</div>
	</div>
      
	<div class="row">
		<div class="col-md-12">
			<p></p>
			
			<div class="btn-group pull-right ">
				<a href="/view/<%= log.id %>.kml" class="btn btn-default"><span class="glyphicon glyphicon-download-alt"></span> KML</a>
				<a href="/view/<%= log.id %>.log" class="btn btn-default"><span class="glyphicon glyphicon-download-alt"></span> Log</a>
			</div>

			<ul class="nav nav-tabs">
				<% if (processed.current.exists) { %><li><a href="#power" data-toggle="tab">Power</a></li><% } %>
				<% if (processed.ctun.exists) { %><li><a href="#altitude" data-toggle="tab">Altitude</a></li><% } %>
				<% if (processed.att.exists) { %><li><a href="#attitude" data-toggle="tab">Attitude</a></li><% } %>
				<% if (processed.gps.exists) { %><li><a href="#gps" data-toggle="tab">GPS</a></li><% } %>
				<% if (processed.imu.exists) { %><li><a href="#imu" data-toggle="tab">IMU</a></li><% } %>
				<li class="active"><a href="#messages" data-toggle="tab">Messages</a></li>
				<li><a href="#params" data-toggle="tab">Params</a></li>
			</ul>
			<p></p>


			<div class="tab-content">
         
        <% if (processed.current.exists) { %>
				<div class="tab-pane" id="power">
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Total Current</h3>
								</div>
								<div class="panel-body">
									<div id="totcurrent-graph"  style="width:100%;height:300px;"></div>
									<p><strong>Total Current Used</strong> <%= processed.current.totcur %> mA</p>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Current over time</h3>
								</div>
								<div class="panel-body">
									<div id="current-graph"  style="width:100%;height:300px;"></div>
									<p><strong>Average Current</strong> <%= processed.current.avgcur %> A</p>
								</div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size visible-md visible-lg"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Voltage over time</h3>
								</div>
								<div class="panel-body"><div id="voltage-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<h3 class="panel-title">Flight Duration Calculator</h3>
								</div>
								<div class="panel-body">
									<form role="form" class="form-horizontal">
  									<div class="form-group">
									    <label for="batteryCapacityInput" class="col-sm-4 control-label">Battery Capacity</label>
							        <div class="col-sm-8">
							        	<% 
							        		var capacity = 0;
							        		if (typeof processed.params != "undefined" && typeof processed.params.batt_capacity != "undefined") {
							        			capacity = parseFloat(processed.params.batt_capacity.value).toFixed(1);
							        		}
							        	%>
									    	<input type="number" class="form-control" id="batteryCapacityInput" placeholder="Enter your battery capacity" value="<%= capacity %>" <%= (capacity==0 ? "" : "disabled") %>>
								    	</div>
									  </div>
									  <div class="form-group">
									    <label for="currentDrawInput" class="col-sm-4 control-label">Average Current Draw</label>
							        <div class="col-sm-8">
									    	<input type="number" class="form-control" id="currentDrawInput" value="<%= processed.current.avgcur %>" disabled>
								    	</div>
									  </div>
									  <div class="form-group">
									    <label for="currentDrawInput" class="col-sm-4 control-label">Estimated Flight Duration</label>
									    <div class="col-sm-8">
												<div class="input-group">
										    	<input type="number" class="form-control" id="currentDrawInput" value="<%= parseFloat(((capacity / 1000 / processed.current.avgcur) * 60 ) * 0.8).toFixed(2) %>" disabled>
													<span class="input-group-addon">mins</span>
												</div>
											</div>
										</div>
									</form>
									<div class="callout callout-info">
										<h4>About this calculator</h4>
										<p>This is a quick and dirty calculation using the Battery Capacity parameter, and the calculated average current draw as measured by your APM.</p>
										<p>Please don't rely on this calculation for future flights! I just found it interesting to compare theortical flight times with actual.</p>
										<p><strong>Also note this calculator incorporates the &quot;80%&quot; rule.</strong></p>
									</div>
								</div>
							</div>
						</div>


					</div>
				</div><!-- /power tab -->
				<% } %>
	          
				<% if (processed.current.exists) { %>
	      <div class="tab-pane" id="altitude">
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Altitude</h3>
								</div>
								<div class="panel-body"><div id="altitude-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>

						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Throttle</h3>
								</div>
								<div class="panel-body"><div id="throttle-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>

					</div>
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Climb Rate</h3>
								</div>
								<div class="panel-body"><div id="crate-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
					</div>
				</div><!-- /altitude tab -->
	      <% } %>      

				<% if (processed.att.exists) { %>
	      <div class="tab-pane" id="attitude">
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Roll</h3>
								</div>
								<div class="panel-body"><div id="attitude-roll-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Pitch</h3>
								</div>
								<div class="panel-body"><div id="attitude-pitch-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Yaw</h3>
								</div>
								<div class="panel-body"><div id="attitude-yaw-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
					</div>
	      </div><!-- /attitude tab -->
	      <% } %>

				<% if (processed.gps.exists) { %>
	      <div class="tab-pane" id="gps">
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Status &amp; HDop</h3>
								</div>
								<div class="panel-body"><div id="gps-status-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Satellites</h3>
								</div>
								<div class="panel-body"><div id="gps-satellites-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Speed</h3>
								</div>
								<div class="panel-body">
									<div id="gps-speed-graph"  style="width:100%;height:300px;"></div>
									<p><strong>Average Speed:</strong> <%= processed.gps.avgSpd %>m/s</p>
								</div>
							</div>
						</div>
					</div>
	      </div><!-- /gps tab -->
	      <% } %>

				<% if (processed.imu.exists) { %>
	      <div class="tab-pane" id="imu">
					<div class="row">
						<div class="col-md-6">
							<div class="panel panel-primary">
								<div class="panel-heading">
									<button class="btn btn-xs btn-primary pull-right toggle-size"><span class="glyphicon glyphicon-resize-full"></button>
									<h3 class="panel-title">Vibrations</h3>
								</div>
								<div class="panel-body"><div id="vibrations-graph"  style="width:100%;height:300px;"></div></div>
							</div>
						</div>
					</div>
				</div>
				<% } %>

				<div class="tab-pane active" id="messages">

	      	
          <% if (processed.err.exists) { %>
            <% for (k in processed.err.errs) { %>
              <div class="alert alert-danger">
                <strong><%= processed.err.errs[k].type %></strong>
                <%= processed.err.errs[k].msg %>
              </div>
            <% } %>
          <% } else { %>
		      	<div class="alert alert-success">
							<strong>Hooray!</strong>
							It would seem that you don't have any error messages from this flight
						</div>
          <% } %>
	      </div>


	      <div class="tab-pane" id="params">

		      <div class="col-md-6 col-md-offset-3">
		        <table class="table table-hover table-striped">
		          <tr>
		            <th>Parameter</th>
		            <th>Value</th>
		          </tr>
		       
	          	<% for (var k in processed.params) { %>
	          		<tr>
	          			<td><%= processed.params[k].name %></td>
	          			<td><%= processed.params[k].value %></td>
          			</tr>
	          	<% } %>
		        
 						</table>
		      </div>
		    </div>
	    </div>
		</div>
	</div>
</div>

<%
scripts = '<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>' +
'<script language="javascript" type="text/javascript" src="/flot/jquery.flot.js"></script>' + 
'<script language="javascript" type="text/javascript" src="/flot/jquery.flot.resize.min.js"></script>' + 
'<script language="javascript" type="text/javascript" src="/flot/jquery.flot.navigate.js"></script>' +
'<script language="javascript" type="text/javascript" src="/flot/jquery.flot.crosshair.js"></script>' +
'<script language="javascript" type="text/javascript" src="/view/' + log.id + '.js"></script>';
%>
